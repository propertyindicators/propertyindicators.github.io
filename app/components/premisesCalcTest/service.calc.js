/*! PILab 02-02-2022 */

"use strict";var __decorate=this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g},__metadata=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/common/http"),model_result_1=require("./model.result"),CalcService=function(){function a(a){this.http=a,this.isInit=!1,this.opexCoef=.85,this.keyList={segms:["sale","rent"],currs:["usd","eur","hrn"]}}return a.prototype.getResultPromise=function(a,b,c){var d=this;return void 0===c&&(c=0),this.isInit?new Promise(function(e){e(d.EvauateResultAndCreateView(a,b,c))}):new Promise(function(c,e){return d.InitData().then(function(){return d.getResultPromise(a,b).then(function(a){return c(a)}).catch(function(a){return e(a)})}).catch(function(a){return e(a)})})},a.prototype.InitData=function(){var a=this,b=this.http.get("./data/test/premcalcdata.json");return new Promise(function(c,d){return b.subscribe(function(b){a.calcData=b,a.isInit=!0,c()},function(a){return d(a)})})},a.prototype.EvauateResultAndCreateView=function(a,b,c){void 0===c&&(c=0);var d=this.CalculateBaseDollarDataSet(a,b,c),e=new model_result_1.ResultViewModel;for(var f in this.keyList.currs)for(var g in this.keyList.segms){var h=d[this.keyList.segms[g]].Multiply(this.GetCurrencyCoef(this.keyList.currs[f],c));e[this.keyList.currs[f]][this.keyList.segms[g]].sqm=h.CreateIndicatorsViewSet(this.keyList.currs[f]),e[this.keyList.currs[f]][this.keyList.segms[g]].premises=h.Multiply(b.square).CreateIndicatorsViewSet(this.keyList.currs[f])}var i=this.CalculateCapitalizRate(d);return e.capitalizRate=i.CreateRateViewSet(!0),e.rentMultiplicator=this.CapRatesToMutlt(i).CreateRateViewSet(!1),e},a.prototype.CalculateCosmoEvaluationSet=function(a,b,c){var d=this.CalculateBaseDollarDataSet(a,b,c);return new model_result_1.CosmoEvaluationSet(this.calcData[c].OnDate,[d.sale.min,d.sale.max,d.sale.main],[d.rent.min,d.rent.max,d.rent.main],[this.GetCurrencyCoef(this.keyList.currs[1],c),this.GetCurrencyCoef(this.keyList.currs[2],c)])},a.prototype.CalculateBaseDollarDataSet=function(a,b,c){return new BaseDataSet(this.CalculateSegmentSqmEvaluationVariation(a,b,"Sale",c),this.CalculateSegmentSqmEvaluationVariation(a,b,"Rent",c))},a.prototype.CalculateSegmentSqmEvaluationVariation=function(a,b,c,d){for(var e=[],f=0;f<3;f++)e.push(this.EvaluateSqm(a,b,this.calcData[d][c].RegSets[f],d));return e=e.sort(function(a,b){return a-b}),new VariationSet(.95*e[0],e[2],(e[0]+e[1]+e[2])/3*.975)},a.prototype.EvaluateSqm=function(a,b,c,d){var e=(a.peopleStreamValue+a.transportStreamValue)/4,f=b.tradevalue_features[0][1]?e>1?e:1:e,g=c.V0*Math.pow(c.S,Math.log(b.square))*Math.pow(c.DC,Math.log(a.destinationCenter+1))*Math.pow(c.P,b.placement)*Math.pow(c.OTB,b.buildtype_otb)*Math.pow(c.MB,b.buildtype_mb)*Math.pow(c.PTS,f)*Math.pow(c.TV,b.tv)*Math.pow(c.TV_PTS,Math.pow(b.tv*f,c.PROG));return b.is_residential_fund&&(g*=c.RF),0===c.B2?(g*=this.calcData[d].Rent.MassiveShifts[a.massive_int-1],g*=Math.pow(c.B1,b.state)):(g*=this.calcData[d].Sale.MassiveShifts[a.massive_int-1],g+=c.B2*b.state),g},a.prototype.GetCurrencyCoef=function(a,b){switch(a){case"usd":return 1;case"hrn":return this.calcData[b].CurEx.Dollar;case"eur":return this.calcData[b].CurEx.Dollar/this.calcData[b].CurEx.Euro;default:return 0}},a.prototype.CalculateCapitalizRate=function(a){return new VariationSet(12*a.rent.min*this.opexCoef/a.sale.max,12*a.rent.max*this.opexCoef/a.sale.min,12*a.rent.main*this.opexCoef/a.sale.main)},a.prototype.CapRatesToMutlt=function(a){return 0===a.max||0===a.min||0===a.main?new VariationSet(1/a.max,1/a.min,1/a.main):new VariationSet(0,0,0)},a=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.HttpClient])],a)}();exports.CalcService=CalcService;var VariationSet=function(){function a(a,b,c){this.min=a,this.max=b,this.main=c,this.curssymb={usd:"$",eur:"€",hrn:"₴"}}return a.prototype.Multiply=function(b){return new a(this.min*b,this.max*b,this.main*b)},a.prototype.CreateIndicatorsViewSet=function(a){return new model_result_1.ResultVariationDataSet(this.IndicatorToString(this.min,a),this.IndicatorToString(this.max,a),this.IndicatorToString(this.main,a))},a.prototype.IndicatorToString=function(a,b){for(var c=String(Math.round(a)),d=c.length,e="",f=1;f<=d;f++)e=f%3==0&&f!=d?" "+c.charAt(d-f)+e:c.charAt(d-f)+e;return e=this.curssymb[b]+" "+e},a.prototype.CreateRateViewSet=function(a){return new model_result_1.ResultVariationDataSet(this.RateToString(this.min,a),this.RateToString(this.max,a),this.RateToString(this.main,a))},a.prototype.RateToString=function(a,b){return b?String(Math.round(1e3*a)/10)+"%":String(Math.round(10*a)/10)},a}(),BaseDataSet=function(){function a(a,b){this.sale=a,this.rent=b}return a}();